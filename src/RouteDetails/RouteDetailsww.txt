import { useCallback, useEffect, useState } from "react";
import { Card, CardContent, Divider, Button } from "@mui/material";

import { RouteDetailsType } from "./Type/RouteDetailsType";
import AddIcon from "@mui/icons-material/Add";
import CustomizedTimeLine from "../TimeLine/CustomizedTimeLine";
import { useAppContext } from "../context/AppContext";
import { PiTruckTrailerBold } from "react-icons/pi";
import { GetDistance, GetTime } from "../Utility";
import Driver from "../Driver/Driver";
import TimeLineBar from "./TimeLineBar";

export default function RouteDetails({ Points }: RouteDetailsType) {
  const {
    NewRoute,
    coordinates,
    currentRouteIndex,
    showDriver,
    timeDistance,
    fixedWorkingHours,
  } = useAppContext();
  const [distanceInKilometers, setDistanceInKilometers] = useState(0);
  const [timeInsight, setTimeInsight] = useState(`00:00:00`);
  const [productCount, setProductCount] = useState(0);
  const [unloadingCount, setUnloadingCount] = useState(0);

  useEffect(() => {
    if (
      coordinates[currentRouteIndex] &&
      coordinates[currentRouteIndex].Route.length
    ) {
      setProductCount(coordinates[currentRouteIndex].Route.length);
      let _count = 0;
      coordinates[currentRouteIndex].Route.forEach((_route) => {
        _count += _route.Products ? _route.Products.length : 0;
      });
      setProductCount(_count);

      setUnloadingCount(coordinates[currentRouteIndex].Route.length);

      let Distance = 0;
      coordinates[currentRouteIndex].Route.forEach(
        (_r) => (Distance += _r?.Distance ? _r?.Distance : 0)
      );

      setDistanceInKilometers(GetDistance(Distance));
      setTimeInsight(GetTime(Distance, timeDistance));
    } else {
      setProductCount(0);
      setUnloadingCount(0);
      setDistanceInKilometers(GetDistance(0));
      setTimeInsight(GetTime(0, timeDistance));
    }
  }, [coordinates, currentRouteIndex, timeDistance]);

  const EstimationOfDeliveryPercent = useCallback(() => {
    return (
      ((distanceInKilometers * timeDistance) / (fixedWorkingHours * 60)) *
      100
    ).toFixed(2); // ظرفیت زمانی
  }, [timeDistance, fixedWorkingHours, distanceInKilometers]);
  return (
    <div className="w-[320px] relative h-full bg-sliderbar flex flex-col  text-black font-medium shadow z-10">
      <div className="h-16 rounded-none bg-primarycolor text-white flex justify-between shadow items-center p-4 m-0">
        <div className="text-sm font-bold flex items-centergap-[6px]">
          <div className="flex items-center">
            <div className="flex justify-center items-center">
              <img
                src="./Dorna.png"
                alt="Profile"
                className="w-8 h-full object-cover"
              />
              <span className="text-xl font-bold text-white">درنا</span>
            </div>
          </div>
        </div>
        <div>
          {/* <div className="route-status planned" style="display:none">
            <i className="fi fi-rr-check"></i>

            <span> برنامه ریزی شده</span>
          </div>
          <div className="route-status not-planned" style="display: flex;">
            برنامه ریزی نشده
          </div> */}
          <div className="text-xs text-yellow-500 p-2 rounded">
            در حال برنامه ریزی
          </div>
        </div>
      </div>
      <div className="h-16 flex p-4 items-center justify-between bg-sidebarcolor gap-[6px]">
        {showDriver ? (
          <Driver />
        ) : (
          <div
            className="gap-[13px] pt-3 pr-3 pb-2 pl-4 flex w-full h-10 bg-green-800 text-white items-start cursor-pointer rounded justify-center bg-center "
            onClick={NewRoute}
          >
            <i className="fi fi-rr-plus"></i>
            <span>جدید</span>
          </div>
        )}
      </div>
      {/* <div className="select-driver" id="driver-selected">
        <div className="not-select" id="showDriver">
          <span>انتخاب راننده</span>
          <i className="fi fi-rr-angle-small-left"></i>
        </div>
        <div className="" id=""></div>
      </div>
      <div className="select-car" id="car-selected">
        <div className="select-car-container">
          <label>نوع ماشین</label>
          <select
            id="CarTypeID"
            name="CarTypeID"
            data-select2-id="select2-data-CarTypeID"
            className="select2-hidden-accessible"
            aria-hidden="true"
          >
            <option value="21" data-select2-id="select2-data-3-6735">
              خرده بار
            </option>
            <option value="9">مزدا</option>
            <option value="5">تک (5.9- 5 m)</option>
            <option value="14">آمیکو (7m)</option>
            <option value="27">مزدا بزرگ (شرکتی)</option>
            <option value="12">نیسان</option>
            <option value="16">لیفتراک</option>
            <option value="26">مزدا کوچک (شرکتی)</option>
            <option value="6">جفت (7-6 m)</option>
            <option value="18">سنگین</option>
            <option value="20">جفت واقعی</option>
            <option value="7">تریلی (12m)</option>
            <option value="19">تک</option>
            <option value="17">موتور</option>
            <option value="15">جفت مسقف (7-6 m)</option>
            <option value="4">911 (4.1 - 4.9 m)</option>
            <option value="2"> خاور(4m)</option>
            <option value="3">وانت</option>
            <option value="25">6 تن (شرکتی)</option>
            <option value="24">5 تن (شرکتی)</option>
            <option value="22">خاور (ایسوزو)</option>
            <option value="23">ماشین سواری</option>
          </select>
          <span
            className="select2 select2-container select2-container--default"
            dir="rtl"
            data-select2-id="select2-data-2-uk1a"
            style="width: 100.625px;"
          >
            <span className="selection">
              <span
                className="select2-selection select2-selection--single select2-selection--clearable"
                role="combobox"
                aria-haspopup="true"
                aria-expanded="false"
                tabindex="0"
                aria-disabled="false"
                aria-labelledby="select2-CarTypeID-container"
                aria-controls="select2-CarTypeID-container"
              >
                <button
                  type="button"
                  className="select2-selection__clear"
                  title="Remove all items"
                  aria-label="Remove all items"
                  aria-describedby="select2-CarTypeID-container"
                  data-select2-id="select2-data-4-4mfq"
                >
                  <span aria-hidden="true">×</span>
                </button>
                <span
                  className="select2-selection__rendered"
                  id="select2-CarTypeID-container"
                  role="textbox"
                  aria-readonly="true"
                  title="خرده بار"
                >
                  خرده بار
                </span>
                <span className="select2-selection__arrow" role="presentation">
                  <b role="presentation"></b>
                  <i className="fi fi-ss-angle-small-down"></i>
                </span>
              </span>
            </span>
            <span className="dropdown-wrapper" aria-hidden="true"></span>
          </span>
        </div>
      </div> */}
      <div className="h-20 p-4 bg-sidebarcolor border border-togglecolor">
        <div className="flex justify-between text-sm">
          <span>جدول زمانی</span>
          <div className="flex flex-row-reverse gap-3">
            <span className="distance">
              {" "}
              {`${distanceInKilometers.toFixed(2)} KM`}
            </span>
            <span className="border border-togglecolor pr-3">
              {" "}
              {timeInsight}
            </span>
          </div>
        </div>
        <div className="flex h-4 mb-2 rounded overflow-hidden p-[1px] mx-0 my-[10px] border border-togglecolor">
          <TimeLineBar />
        </div>
      </div>

      <div className="bg-sidebarcolor border border-togglecolor p-4 grid grid-cols-2 text-sm gap-[10px]">
        <div>
          <label className="text-timelineHeader">تعداد کالا:</label>
          <span>{productCount} عدد</span>
        </div>
        <div>
          <label className="text-timelineHeader">تعداد تخلیه:</label>
          <span>{unloadingCount} مرتبه</span>
        </div>
        <div>
          <label className="text-timelineHeader">ظرفیت زمانی :</label>
          <span> {EstimationOfDeliveryPercent()}%</span>
        </div>
        <div>
          <label className="text-timelineHeader">ظرفیت حجمی:</label>
          <span>00.0%</span>
        </div>
      </div>
      <div className="bg-white p-4 h-full max-h-full overflow-auto flex flex-col flex-1 border-t  border-t-togglecolor border-b border-b-togglecolor  ">
        {Points && Points.Route.length > 0 ? (
          <CustomizedTimeLine Points={Points} />
        ) : (
          <div className="flex flex-col justify-center items-center mt-8">
            <div>
              <PiTruckTrailerBold size={40} />
            </div>
            <p className="text-md text-gray-700 font-bold">
              هنوز مسیری ایجاد نشده
            </p>
          </div>
        )}
      </div>

      <div className="flex p-4 items-center bg-white m-0 border-b border-b-togglecolor">
        <div className="text-sm flex flex-row justify-between flex-1">
          <div>
            <div className="flex bg-gray-200 p-2 rounded h-10 w-40 justify-between items-center border border-togglecolor">
              <div className="flex flex-row-reverse cursor-pointer bg-indigo-500 p-2 rounded text-white w-24 justify-center gap-[12px]">
                <i className="fi fi-rr-truck-moving block"></i>
                <span>سنگین</span>
              </div>
              <div className="flex flex-row-reverse cursor-pointer gap-[3px]">
                <i className="fi fi-rr-truck-pickup hidden"></i>
                <span>سبک</span>
              </div>
            </div>
          </div>
          <span className="py-[13px] px-[16px] inline-block cursor-pointer bg-gray-500 text-white rounded-sm text-base font-medium w-24 h-10 text-center ">
            ثبت مسیر
          </span>
        </div>
      </div>
    </div>
  );
}
